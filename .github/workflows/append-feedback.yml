name: Append feedback issue to file

on:
  issues:
    types: [opened, labeled, edited]

permissions:
  contents: write
  issues: write

jobs:
  append:
    # 只处理带 feedback label 且不带 processed label 的 issue（防重复）
    if: "contains(github.event.issue.labels.*.name, 'feedback') && !contains(github.event.issue.labels.*.name, 'processed')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Append issue body to data/feedback.txt
        shell: bash
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set -euo pipefail

          FILE="data/feedback.txt"
          mkdir -p "$(dirname "$FILE")"
          touch "$FILE"

          BODY="$ISSUE_BODY"

          # 提取 "Message:" 后的块（到 "Meta" 或结尾）
          EXTRACTED=$(printf "%s\n" "$BODY" | awk '
            BEGIN{inmsg=0}
            /^Message:/ {inmsg=1; next}
            /^Meta/ {if(inmsg==1){exit}}
            { if(inmsg==1) print }
          ')

          # 去掉 CR 和前后空行
          EXTRACTED="$(printf "%s\n" "$EXTRACTED" | sed -e 's/\r$//' )"
          EXTRACTED="$(printf "%s\n" "$EXTRACTED" | sed -e :a -e '/^\n*$/{$d;N;ba}' )"
          EXTRACTED="$(printf "%s\n" "$EXTRACTED" | sed -e '1{/^$/d;}' )"

          # 如果没提取到，退回用全正文（不丢数据）
          if [ -z "${EXTRACTED:-}" ]; then
            EXTRACTED="$BODY"
          fi

          {
            echo ""
            echo "-----"
            echo "issue: #${{ github.event.issue.number }}"
            echo "title: ${{ github.event.issue.title }}"
            echo "created: ${{ github.event.issue.created_at }}"
            echo ""
            printf "%s\n" "$EXTRACTED"
            echo ""
          } >> "$FILE"

      - name: Commit and push
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/feedback.txt

          # 没有变更就不提交（避免 workflow 报错）
          git commit -m "Append feedback from issue #${{ github.event.issue.number }}" || exit 0
          git push

      - name: Comment on issue (added to file)
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            const rawUrl = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/main/data/feedback.txt`;
            const body = [
              "已收录 ✅",
              "",
              "- 已追加写入：`data/feedback.txt`",
              `- Raw 读取地址：${rawUrl}`,
              "- Unity 端建议读取时加 `?t=${UnixTime}` 绕过缓存（例如：`" + rawUrl + "?t=1700000000`）",
              "",
              "（此 Issue 将自动关闭，并打上 processed 标签防重复）"
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Add processed label
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["processed"]
            });

      - name: Close issue
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: "closed"
            });
