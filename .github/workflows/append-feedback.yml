name: Append feedback issue to comments.txt (Fixed)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  append:
    # 仅当标签为 feedback 且未处理时运行
    if: github.event.label.name == 'feedback' && !contains(github.event.issue.labels.*.name, 'processed')
    runs-on: ubuntu-latest

    concurrency:
      group: append-comments
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # 始终检出 main 作为基准，由插件负责合并/更新分支
          ref: main

      - name: Extract feedback and append to comments.txt
        shell: bash
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set -euo pipefail

          FILE="comments.txt"
          touch "$FILE"

          # 提取 Message 块逻辑
          BLOCK=$(printf "%s\n" "$ISSUE_BODY" | awk '
            BEGIN{inmsg=0}
            /^Message:/ {inmsg=1; next}
            /^Meta/ {if(inmsg==1){exit}}
            { if(inmsg==1) print }
          ')
          
          if [ -z "${BLOCK:-}" ]; then BLOCK="$ISSUE_BODY"; fi

          parse_field() {
            printf "%s\n" "$BLOCK" | awk -F': ' -v key="$1" '$1==key{sub(/^[^:]*:[ ]*/, "", $0); print; exit}' | sed 's/\r$//'
          }

          sceneName=$(parse_field "sceneName")
          x=$(parse_field "x")
          y=$(parse_field "y")
          message=$(parse_field "message")

          if [ -z "$sceneName" ] && [ -z "$message" ]; then
            echo "Error: No valid content found."
            exit 1
          fi

          {
            echo "sceneName: ${sceneName}"
            echo "x: ${x}"
            echo "y: ${y}"
            echo "message: ${message}"
            echo ""
          } >> "$FILE"

      - name: Create or update single pull request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: auto/comments
          # ⚠️ 修复点：删除 branch-suffix 参数，或设为空
          commit-message: "Append feedback (issue #${{ github.event.issue.number }})"
          title: "Auto-append feedback to comments.txt"
          body: "This PR appends feedback from GitHub Issues automatically."
          add-paths: comments.txt

      - name: Enable PR auto-merge
        if: steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

      - name: Finalize Issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNum = "${{ steps.cpr.outputs.pull-request-number }}";
            const prUrl = "${{ steps.cpr.outputs.pull-request-url }}";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ 成功追加到 PR #${prNum}\n链接: ${prUrl}`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["processed"]
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: "closed"
            });
