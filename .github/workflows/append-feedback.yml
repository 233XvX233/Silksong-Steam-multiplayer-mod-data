name: Append feedback issue to comments.txt (single PR)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  append:
    # ✅ 只有“这次新增的标签就是 feedback”才跑；且未 processed 才跑
    if: github.event.label.name == 'feedback' && !contains(github.event.issue.labels.*.name, 'processed')
    runs-on: ubuntu-latest

    concurrency:
      group: append-comments
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Extract feedback and append to comments.txt
        shell: bash
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set -euo pipefail

          FILE="comments.txt"
          touch "$FILE"

          BODY="$ISSUE_BODY"

          # 提取 Message: 块（到 Meta 或结尾）；没有则回退到全文
          BLOCK=$(printf "%s\n" "$BODY" | awk '
            BEGIN{inmsg=0}
            /^Message:/ {inmsg=1; next}
            /^Meta/ {if(inmsg==1){exit}}
            { if(inmsg==1) print }
          ')
          if [ -z "${BLOCK:-}" ]; then
            BLOCK="$BODY"
          fi

          sceneName=$(printf "%s\n" "$BLOCK" | awk -F': ' '$1=="sceneName"{sub(/^sceneName:[ ]*/, "", $0); print; exit}')
          x=$(printf "%s\n" "$BLOCK" | awk -F': ' '$1=="x"{sub(/^x:[ ]*/, "", $0); print; exit}')
          y=$(printf "%s\n" "$BLOCK" | awk -F': ' '$1=="y"{sub(/^y:[ ]*/, "", $0); print; exit}')
          message=$(printf "%s\n" "$BLOCK" | awk -F': ' '$1=="message"{sub(/^message:[ ]*/, "", $0); print; exit}')

          sceneName=$(printf "%s" "${sceneName:-}" | sed 's/\r$//')
          x=$(printf "%s" "${x:-}" | sed 's/\r$//')
          y=$(printf "%s" "${y:-}" | sed 's/\r$//')
          message=$(printf "%s" "${message:-}" | sed 's/\r$//')

          {
            echo "sceneName: ${sceneName}"
            echo "x: ${x}"
            echo "y: ${y}"
            echo "message: ${message}"
            echo ""
          } >> "$FILE"

      - name: Create or update single pull request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: auto/comments
          delete-branch: false
          commit-message: "Append feedback (issue #${{ github.event.issue.number }})"
          title: "Auto-append feedback to comments.txt"
          body: |
            This PR is maintained by GitHub Actions and continuously appends feedback into comments.txt.
          add-paths: |
            comments.txt

      - name: Enable PR auto-merge (squash)
        if: ${{ success() && steps.cpr.outputs.pull-request-number != '' }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

      - name: Comment on issue
        if: ${{ success() && steps.cpr.outputs.pull-request-number != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number("${{ steps.cpr.outputs.pull-request-number }}");
            const prUrl = "${{ steps.cpr.outputs.pull-request-url }}";
            const rawUrl = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/main/comments.txt`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "已加入队列并写入 PR ✅",
                "",
                `- 已追加到 \`comments.txt\`（统一 PR #${prNumber}）`,
                `- PR 链接：${prUrl}`,
                `- 合并后 Unity Raw：${rawUrl}`,
                "",
                "（此 Issue 将打上 processed 并关闭）"
              ].join("\n")
            });

      - name: Add processed label
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["processed"]
            });

      - name: Close issue
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: "closed"
            });
