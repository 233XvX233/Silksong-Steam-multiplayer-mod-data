name: Append feedback issue to comments.txt (Optimized)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  append:
    if: github.event.label.name == 'feedback' && !contains(github.event.issue.labels.*.name, 'processed')
    runs-on: ubuntu-latest

    concurrency:
      group: append-comments
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # 关键：不指定 ref，让 Action 默认处理或在后面手动 switch

      - name: Prepare Branch
        run: |
          git fetch origin auto/comments || true
          if git show-ref --verify --quiet refs/remotes/origin/auto/comments; then
            git checkout auto/comments
          else
            git checkout main
          fi

      - name: Extract feedback and append to comments.txt
        shell: bash
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set -euo pipefail

          FILE="comments.txt"
          touch "$FILE"

          # 提取 Message 块
          BLOCK=$(printf "%s\n" "$ISSUE_BODY" | awk '
            BEGIN{inmsg=0}
            /^Message:/ {inmsg=1; next}
            /^Meta/ {if(inmsg==1){exit}}
            { if(inmsg==1) print }
          ')
          
          if [ -z "${BLOCK:-}" ]; then BLOCK="$ISSUE_BODY"; fi

          # 解析字段
          parse_field() {
            printf "%s\n" "$BLOCK" | awk -F': ' -v key="$1" '$1==key{sub(/^[^:]*:[ ]*/, "", $0); print; exit}' | sed 's/\r$//'
          }

          sceneName=$(parse_field "sceneName")
          x=$(parse_field "x")
          y=$(parse_field "y")
          message=$(parse_field "message")

          # 如果关键字段全为空，则跳过防止污染文件
          if [ -z "$sceneName" ] && [ -z "$message" ]; then
            echo "Error: Could not parse content. Skipping."
            exit 1
          fi

          {
            echo "sceneName: ${sceneName}"
            echo "x: ${x}"
            echo "y: ${y}"
            echo "message: ${message}"
            echo ""
          } >> "$FILE"

      - name: Create or update single pull request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: auto/comments
          branch-suffix: none  # 确保始终使用同一个分支名进行追加
          delete-branch: false
          commit-message: "Append feedback (issue #${{ github.event.issue.number }})"
          title: "Auto-append feedback to comments.txt"
          body: |
            This PR is maintained by GitHub Actions. 
            Latest update from Issue #${{ github.event.issue.number }}.
          add-paths: comments.txt

      - name: Enable PR auto-merge (squash)
        if: steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

      - name: Update Issue and Close
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = "${{ steps.cpr.outputs.pull-request-number }}";
            const prUrl = "${{ steps.cpr.outputs.pull-request-url }}";
            
            // 1. 添加评论
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ 已成功加入处理队列。\n- 追加至 PR: #${prNumber}\n- 链接: ${prUrl}\n\n该 Issue 将自动关闭并标记为已处理。`
            });

            // 2. 添加标签
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["processed"]
            });

            // 3. 关闭 Issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: "closed"
            });
