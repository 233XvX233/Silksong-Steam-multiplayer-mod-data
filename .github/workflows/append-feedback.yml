name: Append feedback issue to comments.txt

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  append:
    # 只有当标签为 feedback 且未标记为 processed 时运行
    if: github.event.label.name == 'feedback' && !contains(github.event.issue.labels.*.name, 'processed')
    runs-on: ubuntu-latest

    concurrency:
      group: append-comments
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Extract data and format
        id: parser
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";
            
            // 匹配行首的 key: value 模式
            const extract = (key) => {
              const regex = new RegExp(`^${key}\\s*[:：]\\s*(.*)`, 'mi');
              const match = body.match(regex);
              return match ? match[1].trim() : "";
            };

            const sceneName = extract("sceneName");
            const x = extract("x");
            const y = extract("y");
            const message = extract("message");

            if (!sceneName && !message) {
              core.setFailed("解析失败：未能在 Issue 正文中找到 sceneName 或 message 字段。");
              return;
            }

            // 构建输出字符串
            const output = `sceneName: ${sceneName}\nx: ${x}\ny: ${y}\nmessage: ${message}\n`;
            core.exportVariable('EXTRACTED_DATA', output);

      - name: Append to comments.txt
        run: |
          FILE="comments.txt"
          touch "$FILE"
          
          # 如果文件不为空，且末尾没有空行，则先补一个换行
          if [ -s "$FILE" ] && [ "$(tail -c 1 "$FILE" | wc -l)" -eq 0 ]; then
            echo "" >> "$FILE"
          fi
          
          # 确保新条目之前只有一个空行间隔
          if [ -s "$FILE" ]; then
            echo "" >> "$FILE"
          fi
          
          printf "%s" "$EXTRACTED_DATA" >> "$FILE"

      - name: Create or update pull request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: auto/comments
          delete-branch: false
          commit-message: "Append feedback from issue #${{ github.event.issue.number }}"
          title: "Auto-append feedback to comments.txt"
          body: "This PR is automatically managed by GitHub Actions to sync feedback from Issues."
          add-paths: comments.txt

      - name: Enable PR auto-merge
        if: steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

      - name: Close and Label Issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNum = "${{ steps.cpr.outputs.pull-request-number }}";
            const prUrl = "${{ steps.cpr.outputs.pull-request-url }}";
            
            // 添加处理反馈
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **反馈已成功写入队列**\n\n- 数据已追加至 \`comments.txt\`\n- 统一 PR 链接：[#${prNum}](${prUrl})\n\n该 Issue 现已自动标记并关闭。`
            });

            // 打上 processed 标签
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["processed"]
            });

            // 关闭 Issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: "closed"
            });
