name: Append feedback issue to file

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write

jobs:
  append:
    # 只有当 issue 有 feedback label 才执行
    if: contains(github.event.issue.labels.*.name, 'feedback')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Append issue body to data/feedback.txt
        shell: bash
        run: |
          set -euo pipefail

          FILE="data/feedback.txt"
          mkdir -p "$(dirname "$FILE")"
          touch "$FILE"

          # 取 issue 正文
          BODY=$(cat <<'EOF'
${{ github.event.issue.body }}
EOF
)

          # ---- 解析策略：抓取 "Message:" 后面的那段（直到 "Meta" 或结尾）----
          EXTRACTED=$(printf "%s\n" "$BODY" | awk '
            BEGIN{inmsg=0}
            /^Message:/ {inmsg=1; next}
            /^Meta/ {if(inmsg==1){exit}}
            { if(inmsg==1) print }
          ')

          # 去掉前后空行
          EXTRACTED="$(printf "%s\n" "$EXTRACTED" | sed -e 's/\r$//' | sed -e '/^[[:space:]]*$/N;/^\n$/D')"
          EXTRACTED="$(printf "%s\n" "$EXTRACTED" | sed -e :a -e '/^\n*$/{$d;N;ba}')"

          # 如果没提取到（格式不一致），退回直接用整个 BODY（避免丢数据）
          if [ -z "${EXTRACTED:-}" ]; then
            EXTRACTED="$BODY"
          fi

          {
            echo ""
            echo "-----"
            echo "issue: #${{ github.event.issue.number }}"
            echo "title: ${{ github.event.issue.title }}"
            echo "created: ${{ github.event.issue.created_at }}"
            echo ""
            printf "%s\n" "$EXTRACTED"
            echo ""
          } >> "$FILE"

      - name: Commit and push
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/feedback.txt

          # 如果没有变更（比如重复触发但内容相同），不报错
          git commit -m "Append feedback from issue #${{ github.event.issue.number }}" || exit 0
          git push

      - name: Comment on issue (added to file)
        if: ${{ success() }}
        shell: bash
        run: |
          set -euo pipefail

          RAW_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/data/feedback.txt"
          MSG=$(cat <<EOF
已收录 ✅

- 已追加写入：\`data/feedback.txt\`
- Raw 读取地址：$RAW_URL
- Unity 端建议读取时加上 \`?t=\${UnixTime}\` 绕过缓存（例如：\`$RAW_URL?t=1700000000\`）

（此 Issue 将自动关闭）
EOF
)

          # 使用 jq 生成 JSON（ubuntu-latest 通常自带 jq）
          curl -sS -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            -d "$(jq -nc --arg body "$MSG" '{body:$body}')"

      - name: Close issue
        if: ${{ success() }}
        shell: bash
        run: |
          set -euo pipefail

          curl -sS -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}" \
            -d '{"state":"closed"}'
