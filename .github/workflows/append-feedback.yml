name: Append feedback issue to comments.txt (Fixed)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  append:
    # 只有当新增标签是 feedback，且没有 processed 标签时运行
    if: github.event.label.name == 'feedback' && !contains(github.event.issue.labels.*.name, 'processed')
    runs-on: ubuntu-latest

    concurrency:
      group: append-comments
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main # 始终从主分支开始

      - name: Extract data using JavaScript
        id: parser
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";
            
            // 匹配行首的 key: value，兼容中英文冒号和加粗
            const extract = (key) => {
              const regex = new RegExp(`^${key}\\s*[:：]\\s*(.*)`, 'mi');
              const match = body.match(regex);
              return match ? match[1].trim() : "";
            };

            const sceneName = extract("sceneName");
            const x = extract("x");
            const y = extract("y");
            const message = extract("message");

            if (!sceneName && !message) {
              core.setFailed("无法解析 Issue 正文中的反馈数据。");
              return;
            }

            // 将结果存入环境变量供后续步骤使用
            core.exportVariable('EXTRACTED_DATA', `sceneName: ${sceneName}\nx: ${x}\ny: ${y}\nmessage: ${message}\n\n`);

      - name: Append to file
        run: |
          echo "$EXTRACTED_DATA" >> comments.txt

      - name: Create or update pull request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: auto/comments
          # 注意：v6 中不使用 branch-suffix: none，默认即为更新现有分支
          commit-message: "Append feedback (issue #${{ github.event.issue.number }})"
          title: "Auto-append feedback to comments.txt"
          body: "This PR is maintained by GitHub Actions to collect feedback from issues."
          add-paths: comments.txt

      - name: Enable PR auto-merge
        if: steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

      - name: Finalize Issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNum = "${{ steps.cpr.outputs.pull-request-number }}";
            const prUrl = "${{ steps.cpr.outputs.pull-request-url }}";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ 数据已成功提取并排队 PR #${prNum}\n${prUrl}`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["processed"]
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: "closed"
            });
