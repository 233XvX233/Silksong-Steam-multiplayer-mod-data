name: Append feedback issue to comments.txt

on:
  issues:
    types: [opened, labeled, edited]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  append:
    if: "contains(github.event.issue.labels.*.name, 'feedback') && !contains(github.event.issue.labels.*.name, 'processed')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract feedback and append to comments.txt
        shell: bash
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set -euo pipefail

          FILE="comments.txt"
          touch "$FILE"

          BODY="$ISSUE_BODY"

          # 提取 Message: 块（到 Meta 或结尾）
          BLOCK=$(printf "%s\n" "$BODY" | awk '
            BEGIN{inmsg=0}
            /^Message:/ {inmsg=1; next}
            /^Meta/ {if(inmsg==1){exit}}
            { if(inmsg==1) print }
          ')

          # 没有 Message: 就回退到全文
          if [ -z "${BLOCK:-}" ]; then
            BLOCK="$BODY"
          fi

          # 从 block 中解析字段
          sceneName=$(printf "%s\n" "$BLOCK" | awk -F': ' '$1=="sceneName"{sub(/^sceneName:[ ]*/, "", $0); print; exit}')
          x=$(printf "%s\n" "$BLOCK" | awk -F': ' '$1=="x"{sub(/^x:[ ]*/, "", $0); print; exit}')
          y=$(printf "%s\n" "$BLOCK" | awk -F': ' '$1=="y"{sub(/^y:[ ]*/, "", $0); print; exit}')
          message=$(printf "%s\n" "$BLOCK" | awk -F': ' '$1=="message"{sub(/^message:[ ]*/, "", $0); print; exit}')

          # 清理 CR
          sceneName=$(printf "%s" "${sceneName:-}" | sed 's/\r$//')
          x=$(printf "%s" "${x:-}" | sed 's/\r$//')
          y=$(printf "%s" "${y:-}" | sed 's/\r$//')
          message=$(printf "%s" "${message:-}" | sed 's/\r$//')

          # 写入固定格式（严格 4 行 + 空行）
          {
            echo "sceneName: ${sceneName}"
            echo "x: ${x}"
            echo "y: ${y}"
            echo "message: ${message}"
            echo ""
          } >> "$FILE"

      # 使用 PR 提交，避免 main 分支保护问题
      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Append feedback to comments.txt from issue #${{ github.event.issue.number }}"
          title: "Append feedback to comments.txt from issue #${{ github.event.issue.number }}"
          body: |
            Auto-generated from issue #${{ github.event.issue.number }}.
            Appended feedback in normalized format to comments.txt.
          branch: "auto/append-comments-${{ github.event.issue.number }}"
          delete-branch: true
          add-paths: |
            comments.txt

      # ✅ 成功后留言
      - name: Comment on issue
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            const rawUrl = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/main/comments.txt`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "已成功处理 ✅",
                "",
                "",
                "Issue 将被自动关闭"
              ].join("\n")
            });

      # ✅ 成功后打 processed 标签（防重复）
      - name: Add processed label
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["processed"]
            });

      # ✅ 成功后关闭 issue
      - name: Close issue
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: "closed"
            });
