name: Bulk Process Legacy Issues (Enhanced)
on:
  workflow_dispatch: # 手动触发

jobs:
  bulk-append:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Process All Open Issues
        uses: actions/github-script@v7
        env:
          FILE_PATH: "comments.txt"
        with:
          script: |
            const fs = require('fs');
            const path = process.env.FILE_PATH;
            
            // 1. 获取所有打开的 Issue
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            let newData = "";
            let processedCount = 0;

            for (const issue of issues) {
              // 跳过 PR 和已经有 processed 标签的
              if (issue.pull_request) continue;
              if (issue.labels.some(l => l.name === 'processed')) continue;

              const body = issue.body || "";
              
              // 增强版正则解析：兼容大小写、多余空格和不同的换行符
              const extract = (key) => {
                const regex = new RegExp(`${key}:\\s*(.*)`, 'i');
                const match = body.match(regex);
                return match ? match[1].trim() : "";
              };

              const sceneName = extract("sceneName");
              const x = extract("x");
              const y = extract("y");
              const message = extract("message");

              // 只有当至少有 sceneName 或 message 时才记录
              if (sceneName || message) {
                newData += `sceneName: ${sceneName}\nx: ${x}\ny: ${y}\nmessage: ${message}\n\n`;
                
                // 批量操作：打标并关闭
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['processed']
                });
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                processedCount++;
                console.log(`Processed Issue #${issue.number}: ${sceneName}`);
              } else {
                console.log(`Skipped Issue #${issue.number}: Content not match format`);
              }
            }

            if (processedCount > 0) {
              // 读取旧文件内容并在末尾追加
              const currentContent = fs.existsSync(path) ? fs.readFileSync(path, 'utf8') : "";
              fs.writeFileSync(path, currentContent + newData);
            }
            return processedCount;

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "docs: bulk import 134 legacy comments"
          title: "Maintenance: Bulk Import Legacy Feedback"
          branch: maintenance/bulk-fix
          body: "This PR automatically imports all legacy feedback issues into comments.txt."
