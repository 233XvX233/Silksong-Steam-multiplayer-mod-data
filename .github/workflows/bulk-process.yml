name: Bulk Process Legacy Issues (Structural Fix)
on:
  workflow_dispatch:

jobs:
  bulk-append:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Process Issues
        uses: actions/github-script@v7
        env:
          FILE_PATH: "comments.txt"
        with:
          script: |
            const fs = require('fs');
            const path = process.env.FILE_PATH;
            
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            let newData = "";
            let count = 0;

            for (const issue of issues) {
              if (issue.pull_request || issue.labels.some(l => l.name === 'processed')) continue;

              const body = issue.body || "";
              
              // 专门针对你的格式设计的解析函数
              const extract = (key) => {
                // 匹配 key: 之后直到行尾的内容
                const regex = new RegExp(`^${key}\\s*[:：]\\s*(.*)`, 'mi');
                const match = body.match(regex);
                return match ? match[1].trim() : "";
              };

              const sceneName = extract("sceneName");
              const x = extract("x");
              const y = extract("y");
              const message = extract("message");

              // 只要有关键数据就录入
              if (sceneName || message) {
                newData += `sceneName: ${sceneName}\nx: ${x}\ny: ${y}\nmessage: ${message}\n\n`;
                
                // 标记并关闭
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['processed']
                });
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                count++;
              }
            }

            if (count > 0) {
              const current = fs.existsSync(path) ? fs.readFileSync(path, 'utf8') : "";
              // 确保新数据追加在文件末尾，且有清晰分隔
              fs.writeFileSync(path, current.trim() + "\n\n" + newData);
              console.log(`成功从 134 条 Issue 中提取并导入了 ${count} 条反馈。`);
            }
