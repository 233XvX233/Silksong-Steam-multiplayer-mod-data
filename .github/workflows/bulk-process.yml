name: Bulk Process Feedback Issues
on:
  workflow_dispatch: # 手动触发

jobs:
  bulk-append:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process All Open Issues
        uses: actions/github-script@v7
        env:
          FILE_PATH: "comments.txt"
        with:
          script: |
            const fs = require('fs');
            const path = process.env.FILE_PATH;
            
            // 1. 获取所有打开的 Issue (可以根据需要筛选 label)
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            let appendedCount = 0;
            let newData = "";

            for (const issue of issues) {
              // 排除掉已经是 PR 的 Issue
              if (issue.pull_request) continue;
              
              // 解析逻辑 (模拟你之前的 awk 逻辑)
              const body = issue.body || "";
              const extract = (key) => {
                const regex = new RegExp(`${key}:\\s*(.*)`, 'i');
                const match = body.match(regex);
                return match ? match[1].replace(/\r/g, '').trim() : "";
              };

              const sceneName = extract("sceneName");
              const x = extract("x");
              const y = extract("y");
              const message = extract("message");

              // 只有解析出内容的才处理
              if (sceneName || message) {
                newData += `sceneName: ${sceneName}\nx: ${x}\ny: ${y}\nmessage: ${message}\n\n`;
                
                // 给 Issue 打标并关闭
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['processed']
                });
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                appendedCount++;
              }
            }

            if (appendedCount > 0) {
              fs.appendFileSync(path, newData);
              console.log(`Successfully processed ${appendedCount} issues.`);
            }
            
            return appendedCount;

      - name: Create Pull Request for Bulk Update
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Bulk cleanup: Append 134 legacy feedback issues"
          title: "Maintenance: Bulk Feedback Import"
          branch: maintenance/bulk-feedback
          body: "This PR imports legacy feedback from 130+ open issues."
